#!/bin/bash
# Auto-refresh AWS credentials untuk profil yang pakai aws login
# Simpan di: /usr/local/bin/monitoring-hub-wrapper atau ~/.local/bin/monitoring-hub-wrapper

# Daftar profil yang pakai aws login (perlu di-refresh)
AWS_LOGIN_PROFILES=("asg" "nikp" "sandbox" "rumahmedia" "fresnel-master")

# Cek apakah profil yang diminta perlu refresh
PROFILE=""
for arg in "$@"; do
    if [[ "$prev_arg" == "--profile" ]]; then
        PROFILE="$arg"
        break
    fi
    prev_arg="$arg"
done

# Jika profil pakai aws login, refresh credentials ke ~/.aws/credentials
if [[ " ${AWS_LOGIN_PROFILES[@]} " =~ " ${PROFILE} " ]]; then
    echo "ğŸ”„ Refreshing credentials for profile: $PROFILE"
    
    # Export credentials dari aws login
    CREDS=$(aws configure export-credentials --profile "$PROFILE" --format env 2>/dev/null)
    
    if [ $? -eq 0 ]; then
        # Parse credentials
        ACCESS_KEY=$(echo "$CREDS" | grep AWS_ACCESS_KEY_ID | cut -d'=' -f2)
        SECRET_KEY=$(echo "$CREDS" | grep AWS_SECRET_ACCESS_KEY | cut -d'=' -f2)
        SESSION_TOKEN=$(echo "$CREDS" | grep AWS_SESSION_TOKEN | cut -d'=' -f2)
        
        # Buat/update ~/.aws/credentials
        mkdir -p ~/.aws
        touch ~/.aws/credentials
        chmod 600 ~/.aws/credentials
        
        # Hapus section lama jika ada
        sed -i "/^\[$PROFILE\]/,/^$/d" ~/.aws/credentials
        
        # Tambah credentials baru
        cat >> ~/.aws/credentials << EOF

[$PROFILE]
aws_access_key_id = $ACCESS_KEY
aws_secret_access_key = $SECRET_KEY
aws_session_token = $SESSION_TOKEN
EOF
        echo "âœ… Credentials refreshed"
    else
        echo "âŒ Failed to refresh credentials. Run: aws login --profile $PROFILE"
        exit 1
    fi
fi

# Jalankan monitoring-hub asli
exec monitoring-hub "$@"
